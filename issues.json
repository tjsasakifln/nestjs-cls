[{"body":"## Overview\n\nPart 3/3 of comprehensive propagation mode test suite (relates to #13).\n\nThis sub-issue focuses on **race conditions, edge cases, and stress testing** for transaction propagation.\n\n## Test Scope\n\n### 1. Race Conditions (40 tests)\n```typescript\ndescribe('Race conditions', () => {\n  it('handles parent complete before child starts', async () => {\n    const parent = outer();\n    await parent; // Parent done\n    await inner(); // Child starts after parent complete\n  });\n  \n  it('handles parent complete while child active', async () => {\n    await outer(); // Fires inner() but doesn't await\n    // Parent completes while child still running\n  });\n  \n  it('handles new sibling starts after parent complete', async () => {\n    const child1 = inner1();\n    await outer();\n    const child2 = inner2(); // Starts after parent done\n    await Promise.all([child1, child2]);\n  });\n  \n  it('handles concurrent children racing to complete', async () => {\n    // 10 children started simultaneously\n  });\n});\n```\n\n### 2. Parallel Transaction Scenarios (30 tests)\n```typescript\ndescribe('Parallel transactions', () => {\n  it('handles 100 concurrent independent transactions', async () => {\n    const txs = Array(100).fill(0).map(() => service.method());\n    await Promise.all(txs);\n  });\n  \n  it('handles 100 concurrent nested transaction trees', async () => {\n    // Each of 100 requests has nested transactions\n  });\n});\n```\n\n### 3. Error Handling Edge Cases (15 tests)\n```typescript\ndescribe('Error handling', () => {\n  it('handles adapter.startTransaction() failure', async () => {});\n  it('handles adapter.commitTransaction() failure', async () => {});\n  it('handles adapter.rollbackTransaction() failure', async () => {});\n});\n```\n\n### 4. Performance Stress Tests (15 tests)\n```typescript\ndescribe('Performance stress tests', () => {\n  it('completes 1000 transactions within 1 second', async () => {});\n  it('handles deep nesting (10+ levels) without stack overflow', async () => {});\n  it('handles rapid sequential transactions without memory leak', async () => {});\n});\n```\n\n## Test File\n\n```\npackages/transactional/test/propagation/race-conditions.spec.ts\n```\n\n## Success Criteria\n\n- âœ… 100 tests passing\n- âœ… **ZERO race condition failures**\n- âœ… All edge cases handled gracefully\n- âœ… Performance benchmarks met (1000 tx/sec)\n- âœ… No memory leaks in stress tests\n- âœ… **Issue #196 regression tests** (non-awaited children)\n\n## Related\n\n- Part of ROADMAP.md Ronda 4 (Validation)\n- Relates to #13 (parent epic)\n- Depends on #12 (transaction isolation) - âœ… Completed (PR #26)\n- **Addresses Issue #196** (Transaction Already Finished Errors)\n\n## Estimated Effort\n\n- Test implementation: 2.5-3 hours\n- Total: ~3 hours (ATOMIC)","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"},{"id":"LA_kwDOQ93_Vc8AAAACVf8PSw","name":"transactional","description":"Transactional package changes","color":"FF8C00"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":40,"reactionGroups":[],"state":"OPEN","title":"test(transactional): Race conditions and edge cases (100 tests)"},{"body":"## Overview\n\nPart 2/3 of comprehensive propagation mode test suite (relates to #13).\n\nThis sub-issue focuses on **Propagation.RequiresNew, Nested, Supports, NotSupported, Never, and Mandatory** modes.\n\n## Test Scope\n\n### 1. Propagation.RequiresNew (25 tests)\n```typescript\ndescribe('Propagation.RequiresNew', () => {\n  it('creates new transaction even when parent exists', async () => {\n    await outer(); // tx1 (Required)\n      await inner(); // tx2 (RequiresNew) - always new\n  });\n  \n  it('suspends parent transaction', async () => {\n    // tx1 paused while tx2 active\n  });\n  \n  it('handles nested RequiresNew', async () => {\n    // tx1 â†’ tx2 (RequiresNew) â†’ tx3 (RequiresNew)\n  });\n});\n```\n\n### 2. Propagation.Nested (20 tests)\n```typescript\ndescribe('Propagation.Nested', () => {\n  it('creates nested transaction within parent', async () => {});\n  it('nested rollback does not affect parent', async () => {});\n  it('parent rollback rolls back nested', async () => {});\n});\n```\n\n### 3. Propagation.Supports (15 tests)\n```typescript\ndescribe('Propagation.Supports', () => {\n  it('joins transaction if parent exists', async () => {});\n  it('runs without transaction if no parent', async () => {});\n});\n```\n\n### 4. Propagation.NotSupported (15 tests)\n```typescript\ndescribe('Propagation.NotSupported', () => {\n  it('suspends parent transaction and runs without tx', async () => {});\n  it('runs without transaction when no parent', async () => {});\n});\n```\n\n### 5. Propagation.Never (15 tests)\n```typescript\ndescribe('Propagation.Never', () => {\n  it('throws error if parent transaction exists', async () => {\n    await expect(outer()).rejects.toThrow(/transaction exists/);\n  });\n  it('runs without transaction when no parent', async () => {});\n});\n```\n\n### 6. Propagation.Mandatory (10 tests)\n```typescript\ndescribe('Propagation.Mandatory', () => {\n  it('throws error if no parent transaction', async () => {\n    await expect(method()).rejects.toThrow(/no transaction/);\n  });\n  it('joins parent transaction when exists', async () => {});\n});\n```\n\n## Test File\n\n```\npackages/transactional/test/propagation/all-modes.spec.ts\n```\n\n## Success Criteria\n\n- âœ… 100 tests passing\n- âœ… All 6 propagation modes validated\n- âœ… Correct behavior for each mode with/without parent\n- âœ… Error handling for Never/Mandatory modes\n- âœ… Coverage >90% in propagation logic\n\n## Related\n\n- Part of ROADMAP.md Ronda 4 (Validation)\n- Relates to #13 (parent epic)\n- Depends on #12 (transaction isolation) - âœ… Completed (PR #26)\n\n## Estimated Effort\n\n- Test implementation: 2.5-3 hours\n- Total: ~3 hours (ATOMIC)","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"},{"id":"LA_kwDOQ93_Vc8AAAACVf8PSw","name":"transactional","description":"Transactional package changes","color":"FF8C00"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":39,"reactionGroups":[],"state":"OPEN","title":"test(transactional): Propagation.RequiresNew and other modes (100 tests)"},{"body":"## Overview\n\nPart 1/3 of comprehensive propagation mode test suite (relates to #13).\n\nThis sub-issue focuses on **Propagation.Required with isolated context** to prevent transaction corruption.\n\n## Test Scope\n\n### 1. Basic Propagation.Required (25 tests)\n```typescript\ndescribe('Propagation.Required - basic', () => {\n  it('creates new transaction when no parent exists', async () => {\n    await service.method(); // Should create tx\n    expect(adapter.startTransactionCalls).toBe(1);\n  });\n  \n  it('creates isolated transaction when parent exists', async () => {\n    // After Issue #12 fix: nested Required creates isolated tx\n    await service.outer(); // Creates tx1\n    // â†’ calls inner() which creates isolated tx2\n    expect(adapter.startTransactionCalls).toBe(2);\n  });\n});\n```\n\n### 2. Nested Awaited Transactions (25 tests)\n```typescript\ndescribe('Nested awaited Required', () => {\n  it('handles parent â†’ child (both awaited)', async () => {\n    await outer(); // tx1\n      await inner(); // isolated tx2\n    // Both complete successfully\n  });\n  \n  it('handles parent rollback without affecting child', async () => {\n    // Parent rolls back, child already committed\n  });\n  \n  it('handles child rollback without affecting parent', async () => {\n    // Child rolls back, parent continues\n  });\n});\n```\n\n### 3. Nested NON-Awaited Transactions (25 tests)\n```typescript\ndescribe('Nested non-awaited Required', () => {\n  it('handles parent complete before child (Issue #196)', async () => {\n    const childPromise = inner(); // Fire-and-forget\n    await outer(); // Completes first\n    await childPromise; // Should NOT throw \"Transaction already finished\"\n  });\n  \n  it('handles multiple non-awaited children', async () => {\n    const children = [inner1(), inner2(), inner3()];\n    await outer();\n    await Promise.all(children); // All succeed\n  });\n});\n```\n\n### 4. Multiple Nesting Levels (25 tests)\n```typescript\ndescribe('Deep nesting (3+ levels)', () => {\n  it('handles outer â†’ middle â†’ inner (all Required)', async () => {\n    // 3 isolated transactions\n  });\n  \n  it('handles 5-level nesting', async () => {});\n});\n```\n\n## Test File\n\n```\npackages/transactional/test/propagation/required-isolation.spec.ts\n```\n\n## Success Criteria\n\n- âœ… 100 tests passing\n- âœ… **Issue #196 fixed** (non-awaited transactions don't cause \"Transaction already finished\")\n- âœ… All nested scenarios work with isolated contexts\n- âœ… No transaction corruption\n- âœ… Coverage >90% in transaction-host.ts\n\n## Related\n\n- Part of ROADMAP.md Ronda 4 (Validation)\n- Relates to #13 (parent epic)\n- Depends on #12 (transaction isolation) - âœ… Completed (PR #26)\n- **Addresses Issue #196** (Transaction Already Finished Errors)\n\n## Estimated Effort\n\n- Test implementation: 2.5-3 hours\n- Total: ~3 hours (ATOMIC)","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"},{"id":"LA_kwDOQ93_Vc8AAAACVf8PSw","name":"transactional","description":"Transactional package changes","color":"FF8C00"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":38,"reactionGroups":[],"state":"OPEN","title":"test(transactional): Propagation.Required isolation scenarios (100 tests)"},{"body":"## Overview\n\nPart 3/3 of context tracking edge case test suite (relates to #10).\n\nThis sub-issue focuses on **mock objects, spies, and test doubles** commonly used in testing scenarios.\n\n## Test Scope\n\n### 1. Jest Mocks (30 tests)\n```typescript\ndescribe('Jest mock objects', () => {\n  it('tracks context with jest.fn() spy', async () => {\n    const mockRequest = jest.fn().mockReturnValue({ id: '123' });\n  });\n  \n  it('tracks context with jest.spyOn()', async () => {});\n  \n  it('tracks context with jest.mock() module mock', async () => {});\n});\n```\n\n### 2. Object.create() Clones (30 tests)\n```typescript\ndescribe('Object.create clones', () => {\n  it('tracks context with Object.create(request)', async () => {\n    const clone = Object.create(request);\n    // WeakMap fails, Symbol tagging should work\n  });\n  \n  it('tracks context with Object.create(request, descriptors)', async () => {});\n  \n  it('handles prototype chain identity', async () => {\n    // request â†’ clone1 â†’ clone2 (prototype chain)\n  });\n});\n```\n\n### 3. Object.assign() and Spread (20 tests)\n```typescript\ndescribe('Object.assign and spread', () => {\n  it('tracks context with Object.assign({}, request)', async () => {\n    const copy = Object.assign({}, request);\n  });\n  \n  it('tracks context with spread operator ({ ...request })', async () => {});\n  \n  it('handles partial spread with overrides', async () => {\n    const modified = { ...request, id: 'override' };\n  });\n});\n```\n\n### 4. Testing Library Scenarios (20 tests)\n```typescript\ndescribe('Testing library compatibility', () => {\n  it('works with @nestjs/testing mocks', async () => {});\n  it('works with supertest request objects', async () => {});\n  it('works with custom test doubles', async () => {});\n});\n```\n\n## Test File\n\n```\npackages/core/test/edge-cases/mock-context-tracking.spec.ts\n```\n\n## Success Criteria\n\n- âœ… 100 tests passing\n- âœ… **100% success rate** with mock objects\n- âœ… Compatible with Jest mocking utilities\n- âœ… Works with Object.create(), Object.assign(), spread operator\n- âœ… No false positives with test doubles\n- âœ… **Improves testing DX** (developers can use mocks safely)\n\n## Related\n\n- Part of ROADMAP.md Ronda 4 (Validation)\n- Relates to #10 (parent epic)\n- Depends on #9 (Symbol+WeakMap hybrid) - âœ… Completed (commit 79aeab2)\n\n## Estimated Effort\n\n- Test implementation: 2-3 hours\n- Total: ~2.5 hours (ATOMIC)","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8NUw","name":"core","description":"Core package changes","color":"D73A4A"},{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":37,"reactionGroups":[],"state":"OPEN","title":"test(core): Mock objects and test doubles for context tracking (100 tests)"},{"body":"## Overview\n\nPart 2/3 of context tracking edge case test suite (relates to #10).\n\nThis sub-issue focuses on **frozen and sealed object scenarios** where Symbol tagging is impossible and WeakMap fallback is required.\n\n## Test Scope\n\n### 1. Frozen Objects (35 tests)\n```typescript\ndescribe('Frozen request objects', () => {\n  it('tracks context with Object.freeze(request)', async () => {\n    const frozen = Object.freeze({ ...request });\n    // Symbol tagging fails, WeakMap fallback should work\n    expect(cls.getId()).toBeDefined();\n  });\n  \n  it('tracks context across multiple enhancers with frozen request', async () => {\n    // ClsMiddleware â†’ ClsGuard with frozen request\n  });\n  \n  it('prevents false positives with different frozen objects', async () => {\n    // Two requests, both frozen, should get different contexts\n  });\n});\n```\n\n### 2. Sealed Objects (35 tests)\n```typescript\ndescribe('Sealed request objects', () => {\n  it('tracks context with Object.seal(request)', async () => {\n    const sealed = Object.seal({ ...request });\n    // Symbol tagging fails, WeakMap fallback should work\n  });\n  \n  it('handles partially sealed objects', async () => {\n    // Some properties sealed, others not\n  });\n});\n```\n\n### 3. Non-Extensible Objects (15 tests)\n```typescript\ndescribe('Non-extensible objects', () => {\n  it('tracks context with Object.preventExtensions(request)', async () => {\n    const nonExt = Object.preventExtensions({ ...request });\n  });\n});\n```\n\n### 4. Mixed Scenarios (15 tests)\n```typescript\ndescribe('Mixed frozen/sealed/extensible', () => {\n  it('handles transition from extensible to frozen', async () => {\n    // Request starts extensible, becomes frozen mid-request\n  });\n  \n  it('handles concurrent requests with mix of frozen/extensible', async () => {\n    // Some requests frozen, others not\n  });\n});\n```\n\n## Test File\n\n```\npackages/core/test/edge-cases/frozen-context-tracking.spec.ts\n```\n\n## Success Criteria\n\n- âœ… 100 tests passing\n- âœ… **100% success rate** with frozen/sealed objects\n- âœ… WeakMap fallback activates when Symbol tagging fails\n- âœ… No crashes when Symbol.for() can't be added\n- âœ… Graceful degradation for non-extensible objects\n\n## Related\n\n- Part of ROADMAP.md Ronda 4 (Validation)\n- Relates to #10 (parent epic)\n- Depends on #9 (Symbol+WeakMap hybrid) - âœ… Completed (commit 79aeab2)\n\n## Estimated Effort\n\n- Test implementation: 2-3 hours\n- Total: ~2.5 hours (ATOMIC)","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8NUw","name":"core","description":"Core package changes","color":"D73A4A"},{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":36,"reactionGroups":[],"state":"OPEN","title":"test(core): Frozen/sealed objects for context tracking (100 tests)"},{"body":"## Overview\n\nPart 1/3 of context tracking edge case test suite (relates to #10).\n\nThis sub-issue focuses on **Proxy wrapper scenarios** where WeakMap-only identity tracking fails.\n\n## Test Scope\n\n### 1. Basic Proxy Wrappers (30 tests)\n```typescript\ndescribe('Proxy wrappers', () => {\n  it('tracks context with Proxy(request, {})', async () => {\n    const proxy = new Proxy(request, {});\n    // Symbol tagging should work, WeakMap fallback if needed\n    expect(cls.getId()).toBeDefined();\n  });\n  \n  it('tracks context with Proxy(request, { get: ... })', async () => {\n    // Proxy with getter trap\n  });\n  \n  it('tracks context with revocable Proxy', async () => {});\n});\n```\n\n### 2. Nested Proxy Chains (25 tests)\n```typescript\ndescribe('Nested proxy chains', () => {\n  it('handles Proxy(Proxy(request))', async () => {\n    // Double-wrapped proxy\n  });\n  \n  it('handles deep proxy chains (5+ levels)', async () => {});\n});\n```\n\n### 3. Proxy with Transformations (25 tests)\n```typescript\ndescribe('Transforming proxies', () => {\n  it('tracks context when proxy modifies properties', async () => {\n    const proxy = new Proxy(request, {\n      get(target, prop) {\n        return `transformed-${target[prop]}`;\n      }\n    });\n  });\n  \n  it('handles proxy that adds new properties', async () => {});\n  it('handles proxy that deletes properties', async () => {});\n});\n```\n\n### 4. Framework Enhancer + Proxy (20 tests)\n- ClsMiddleware receives Proxy-wrapped request\n- ClsGuard receives Proxy-wrapped request (Issue #129 scenario)\n- Multiple enhancers with different proxy wrappers\n\n## Test File\n\n```\npackages/core/test/edge-cases/proxy-context-tracking.spec.ts\n```\n\n## Success Criteria\n\n- âœ… 100 tests passing\n- âœ… **100% success rate** with Proxy objects (vs 29.4% with WeakMap-only)\n- âœ… Symbol tagging works through Proxy wrappers\n- âœ… WeakMap fallback used when Symbol can't be added\n- âœ… **Addresses Issue #129** (ClsGuard context leaking with Proxy)\n\n## Related\n\n- Part of ROADMAP.md Ronda 4 (Validation)\n- Relates to #10 (parent epic)\n- Depends on #9 (Symbol+WeakMap hybrid) - âœ… Completed (commit 79aeab2)\n- **Addresses Issue #129** (WeakMap identity fails with Proxy)\n\n## Estimated Effort\n\n- Test implementation: 2-3 hours\n- Total: ~2.5 hours (ATOMIC)","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8NUw","name":"core","description":"Core package changes","color":"D73A4A"},{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":35,"reactionGroups":[],"state":"OPEN","title":"test(core): Proxy object edge cases for context tracking (100 tests)"},{"body":"## Overview\n\nPart 4/4 of framework-agnostic request identity test suite (relates to #7).\n\nThis sub-issue focuses on **cross-framework multi-enhancer scenarios** to validate that RequestIdentityResolver works correctly when multiple CLS enhancers are used together.\n\n## Test Scope\n\n### 1. Enhancer Combinations (30 tests)\n```typescript\ndescribe('Enhancer combinations', () => {\n  it('works with Middleware + Guard', async () => {});\n  it('works with Middleware + Interceptor', async () => {});\n  it('works with Guard + Interceptor', async () => {});\n  it('works with Middleware + Guard + Interceptor', async () => {});\n  \n  // Repeat for Express, Fastify, Koa (3 frameworks Ã— 4 combos = 12 tests)\n});\n```\n\n### 2. Context Leak Prevention (30 tests)\n```typescript\ndescribe('Context leak prevention', () => {\n  it('prevents leak with 100 concurrent requests (Express)', async () => {\n    // All enhancers enabled\n    const ids = await Promise.all(Array(100).fill(0).map(makeRequest));\n    expect(new Set(ids)).toHaveLength(100);\n  });\n  \n  it('prevents leak with 100 concurrent requests (Fastify)', async () => {\n    // Issue #223 regression test\n  });\n  \n  it('prevents leak with 100 concurrent requests (Koa)', async () => {});\n  \n  it('prevents leak with rapid sequential requests', async () => {\n    // Back-to-back requests without delay\n  });\n});\n```\n\n### 3. Enhancer Execution Order (20 tests)\n```typescript\ndescribe('Enhancer execution order', () => {\n  it('maintains context across Middleware â†’ Guard â†’ Controller', async () => {});\n  it('maintains context across Middleware â†’ Interceptor â†’ Controller', async () => {});\n  it('maintains context through exception filters', async () => {});\n});\n```\n\n### 4. Edge Cases (20 tests)\n```typescript\ndescribe('Multi-enhancer edge cases', () => {\n  it('handles enhancers in different modules', async () => {\n    // Global middleware + local guard\n  });\n  \n  it('handles frozen request objects', async () => {\n    // Symbol can't be added, fallback to WeakMap\n  });\n  \n  it('handles request transformers between enhancers', async () => {});\n});\n```\n\n## Test File\n\n```\npackages/core/test/integration/multi-enhancer-scenarios.spec.ts\n```\n\n## Success Criteria\n\n- âœ… 100 tests passing\n- âœ… All enhancer combinations work across all 3 frameworks\n- âœ… **ZERO context leaks** in concurrent scenarios\n- âœ… Context maintained across enhancer execution order\n- âœ… **Addresses Issue #223** (Fastify multi-enhancer regression test)\n- âœ… **Addresses Issue #129** (ClsGuard context leaking)\n\n## Related\n\n- Part of ROADMAP.md Ronda 4 (Validation)\n- Relates to #7 (parent epic)\n- Depends on #6 (RequestIdentityResolver) - âœ… Completed (PR #24)\n- **Addresses Issue #223** (Fastify multi-enhancer context leaking)\n- **Addresses Issue #129** (ClsGuard context leaking)\n\n## Estimated Effort\n\n- Test implementation: 2.5-3 hours\n- Total: ~3 hours (ATOMIC)","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8NUw","name":"core","description":"Core package changes","color":"D73A4A"},{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":34,"reactionGroups":[],"state":"OPEN","title":"test(core): Multi-enhancer scenarios across frameworks (100 tests)"},{"body":"## Overview\n\nPart 3/4 of framework-agnostic request identity test suite (relates to #7).\n\nThis sub-issue focuses on **Koa 2.x integration testing** for RequestIdentityResolver.\n\n## Test Scope\n\n### 1. Basic Koa Integration (30 tests)\n```typescript\ndescribe('Koa request identity', () => {\n  it('tracks identity via ctx.request', async () => {\n    // Koa uses ctx.request instead of req\n    expect(requestId1).not.toEqual(requestId2);\n  });\n  \n  it('handles Koa context (ctx) vs request distinction', async () => {\n    // Verify we tag the correct object (ctx.request, not ctx)\n  });\n  \n  it('handles concurrent requests without leaking', async () => {\n    const results = await Promise.all(Array(100).fill(0).map(makeRequest));\n    expect(new Set(results)).toHaveLength(100);\n  });\n});\n```\n\n### 2. Koa Middleware Compatibility (30 tests)\n```typescript\ndescribe('Koa middleware', () => {\n  it('works with koa-bodyparser', async () => {});\n  it('works with koa-router', async () => {});\n  it('works with koa-session', async () => {});\n  it('works with koa-compress', async () => {});\n});\n```\n\n### 3. Koa-Specific Edge Cases (20 tests)\n```typescript\ndescribe('Koa edge cases', () => {\n  it('handles ctx delegation (ctx.body, ctx.status)', async () => {\n    // Koa delegates properties to request/response\n  });\n  \n  it('handles custom ctx properties', async () => {\n    // ctx.state, ctx.assert, etc.\n  });\n  \n  it('handles error middleware transforming ctx', async () => {});\n});\n```\n\n### 4. Multi-Enhancer with Koa (20 tests)\n- ClsMiddleware + ClsGuard\n- ClsMiddleware + ClsInterceptor\n- All three enhancers together\n\n## Test File\n\n```\npackages/core/test/integration/koa-request-identity.spec.ts\n```\n\n## Success Criteria\n\n- âœ… 100 tests passing\n- âœ… Works with Koa 2.x\n- âœ… 100 concurrent requests without context leak\n- âœ… Correctly identifies ctx.request as canonical object\n- âœ… Compatible with popular Koa middleware\n\n## Related\n\n- Part of ROADMAP.md Ronda 4 (Validation)\n- Relates to #7 (parent epic)\n- Depends on #6 (RequestIdentityResolver) - âœ… Completed (PR #24)\n\n## Estimated Effort\n\n- Test implementation: 2-3 hours\n- Total: ~2.5 hours (ATOMIC)","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8NUw","name":"core","description":"Core package changes","color":"D73A4A"},{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":33,"reactionGroups":[],"state":"OPEN","title":"test(core): Koa request identity integration (100 tests)"},{"body":"## Overview\n\nPart 2/4 of framework-agnostic request identity test suite (relates to #7).\n\nThis sub-issue focuses on **Fastify (v4 and v5) integration testing** for RequestIdentityResolver.\n\n## Test Scope\n\n### 1. Basic Fastify Integration (25 tests)\n```typescript\ndescribe('Fastify request identity', () => {\n  it('tracks identity without relying on request.raw hack', async () => {\n    // Verify old `request.raw ?? request` hack is NOT used\n    // Verify Symbol tagging works directly on request\n  });\n  \n  it('handles concurrent requests without leaking', async () => {\n    // 100 concurrent requests\n    const results = await Promise.all(Array(100).fill(0).map(makeRequest));\n    expect(new Set(results)).toHaveLength(100);\n  });\n});\n```\n\n### 2. Fastify v4 vs v5 Compatibility (25 tests)\n```typescript\ndescribe('Fastify version compatibility', () => {\n  it('works with Fastify 4.x request objects', async () => {});\n  it('works with Fastify 5.x request objects', async () => {});\n  it('handles request.raw differences between versions', async () => {});\n});\n```\n\n### 3. Fastify-Specific Edge Cases (25 tests)\n```typescript\ndescribe('Fastify edge cases', () => {\n  it('handles request with decorators', async () => {\n    // fastify.decorateRequest()\n  });\n  \n  it('handles request with hooks', async () => {\n    // onRequest, preParsing, etc.\n  });\n  \n  it('handles request with schema validation', async () => {});\n  \n  it('handles GraphQL Mercurius requests', async () => {\n    // Verify compatibility with Mercurius plugin\n  });\n});\n```\n\n### 4. Multi-Enhancer with Fastify (25 tests)\n- ClsMiddleware + ClsGuard (Issue #223 scenario)\n- ClsMiddleware + ClsInterceptor\n- All three enhancers together\n- Verify NO context leaking (Issue #223 regression test)\n\n## Test File\n\n```\npackages/core/test/integration/fastify-request-identity.spec.ts\n```\n\n## Success Criteria\n\n- âœ… 100 tests passing\n- âœ… Works with both Fastify 4 and 5\n- âœ… 100 concurrent requests without context leak\n- âœ… **Fixes Issue #223** (Fastify multi-enhancer context leaking)\n- âœ… No reliance on `request.raw` hack\n- âœ… Compatible with Mercurius GraphQL plugin\n\n## Related\n\n- Part of ROADMAP.md Ronda 4 (Validation)\n- Relates to #7 (parent epic)\n- Depends on #6 (RequestIdentityResolver) - âœ… Completed (PR #24)\n- **Addresses Issue #223** (Fastify multi-enhancer context leaking)\n\n## Estimated Effort\n\n- Test implementation: 2-3 hours\n- Total: ~2.5 hours (ATOMIC)","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8NUw","name":"core","description":"Core package changes","color":"D73A4A"},{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":32,"reactionGroups":[],"state":"OPEN","title":"test(core): Fastify request identity integration (100 tests)"},{"body":"## Overview\n\nPart 1/4 of framework-agnostic request identity test suite (relates to #7).\n\nThis sub-issue focuses on **Express (v4 and v5) integration testing** for RequestIdentityResolver.\n\n## Test Scope\n\n### 1. Basic Express Integration (25 tests)\n```typescript\ndescribe('Express request identity', () => {\n  it('tracks identity with ClsMiddleware', async () => {\n    // Verify Symbol tagging works\n    expect(requestId1).not.toEqual(requestId2);\n  });\n  \n  it('handles concurrent requests without leaking', async () => {\n    // 100 concurrent requests\n    const results = await Promise.all(Array(100).fill(0).map(makeRequest));\n    expect(new Set(results)).toHaveLength(100);\n  });\n});\n```\n\n### 2. Express v4 vs v5 Compatibility (25 tests)\n```typescript\ndescribe('Express version compatibility', () => {\n  it('works with Express 4.x request objects', async () => {});\n  it('works with Express 5.x request objects', async () => {});\n  it('handles differences in req object structure', async () => {});\n});\n```\n\n### 3. Express-Specific Edge Cases (25 tests)\n```typescript\ndescribe('Express edge cases', () => {\n  it('handles req with middleware transformations', async () => {\n    // Express middleware that wraps/modifies req\n  });\n  \n  it('handles req with body-parser', async () => {});\n  it('handles req with express-session', async () => {});\n  it('handles req with passport', async () => {});\n});\n```\n\n### 4. Multi-Enhancer with Express (25 tests)\n- ClsMiddleware + ClsGuard\n- ClsMiddleware + ClsInterceptor\n- All three enhancers together\n\n## Test File\n\n```\npackages/core/test/integration/express-request-identity.spec.ts\n```\n\n## Success Criteria\n\n- âœ… 100 tests passing\n- âœ… Works with both Express 4 and 5\n- âœ… 100 concurrent requests without context leak\n- âœ… No false positives (different requests get different IDs)\n- âœ… No false negatives (same request gets same ID across enhancers)\n\n## Related\n\n- Part of ROADMAP.md Ronda 4 (Validation)\n- Relates to #7 (parent epic)\n- Depends on #6 (RequestIdentityResolver) - âœ… Completed (PR #24)\n\n## Estimated Effort\n\n- Test implementation: 2-3 hours\n- Total: ~2.5 hours (ATOMIC)","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8NUw","name":"core","description":"Core package changes","color":"D73A4A"},{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":31,"reactionGroups":[],"state":"OPEN","title":"test(core): Express request identity integration (100 tests)"},{"body":"## Overview\n\nPart 4/4 of comprehensive circular dependency test suite (relates to #4).\n\nThis sub-issue focuses on **edge cases and performance benchmarks** for cycle detection.\n\n## Test Scope\n\n### 1. Edge Cases (30 tests)\n```typescript\ndescribe('Edge cases', () => {\n  it('handles empty provider graph', async () => {\n    expect(await module.get(Symbol())).rejects.toThrow();\n  });\n  \n  it('handles single provider with no dependencies', async () => {\n    expect(await module.get(A)).toBeDefined();\n  });\n  \n  it('handles Symbol.for() shared symbols across modules', async () => {\n    // Multiple modules using same registered symbol\n  });\n  \n  it('handles providers with undefined/null dependencies', async () => {\n    // Gracefully handle malformed provider metadata\n  });\n  \n  it('handles cycles with frozen providers', async () => {\n    const frozen = Object.freeze({ provide: A, useValue: {} });\n  });\n});\n```\n\n### 2. Performance Benchmarks (20 tests)\n```typescript\ndescribe('Performance benchmarks', () => {\n  it('detects cycle in 100 providers within 5ms', async () => {\n    const start = performance.now();\n    expect(() => module.get(A)).toThrow();\n    expect(performance.now() - start).toBeLessThan(5);\n  });\n  \n  it('detects cycle in 1000 providers within 10ms', async () => {\n    // Target from ROADMAP: <10ms for 1000+ providers\n  });\n  \n  it('validates valid DAG with 1000 providers within 10ms', async () => {\n    // Ensure no false positives AND fast\n  });\n  \n  it('handles 10,000 providers without cycles within 100ms', async () => {\n    // Stress test: large valid graph\n  });\n});\n```\n\n### 3. Error Quality Tests (edge cases for messages)\n- Unnamed providers (Symbol without description)\n- Providers with special characters in names\n- Very long cycle paths (10+ nodes)\n\n## Test Files\n\n```\npackages/core/test/proxy-providers/circular-deps-edge-cases.spec.ts\npackages/core/test/proxy-providers/circular-deps-performance.spec.ts\n```\n\n## Success Criteria\n\n- âœ… 50 tests passing (30 edge cases + 20 performance)\n- âœ… All performance benchmarks met:\n  - 100 providers: <5ms\n  - 1000 providers: <10ms  \n  - 10,000 providers: <100ms\n- âœ… All edge cases handled gracefully (no crashes)\n- âœ… Error messages remain clear even for edge cases\n\n## Related\n\n- Part of ROADMAP.md Ronda 4 (Validation)\n- Relates to #4 (parent epic)\n- Depends on #17 (DependencyGraph integration) - âœ… Completed\n\n## Estimated Effort\n\n- Test implementation: 1.5 hours\n- Performance tuning if needed: 0.5 hours\n- Total: ~2 hours (ATOMIC)","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8NUw","name":"core","description":"Core package changes","color":"D73A4A"},{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":30,"reactionGroups":[],"state":"OPEN","title":"test(core): Circular dependency edge cases & performance (50 tests)"},{"body":"## Overview\n\nPart 3/4 of comprehensive circular dependency test suite (relates to #4).\n\nThis sub-issue focuses on **validating that legitimate DAGs (Directed Acyclic Graphs) don't trigger false positive cycle detection**.\n\n## Test Scope\n\n### 1. Diamond Dependencies (15 tests)\n```typescript\ndescribe('Diamond dependency patterns', () => {\n  it('allows diamond (Aâ†’B,C; B,Câ†’D)', async () => {\n    // Not a cycle, just multiple paths to D\n    expect(await module.get(A)).toBeDefined();\n    expect(await module.get(D)).toBeDefined();\n  });\n  \n  it('allows nested diamonds', async () => {\n    // Aâ†’B,C; Bâ†’D,E; Câ†’D,E; D,Eâ†’F\n  });\n});\n```\n\n### 2. Linear Chains (10 tests)\n```typescript\ndescribe('Linear dependency chains', () => {\n  it('allows simple linear chain (Aâ†’Bâ†’Câ†’D)', async () => {\n    expect(await module.get(A)).toBeDefined();\n  });\n  \n  it('allows long linear chain (20+ nodes)', async () => {\n    // Aâ†’Bâ†’Câ†’...â†’Z (no cycles)\n  });\n});\n```\n\n### 3. Tree Structures (15 tests)\n```typescript\ndescribe('Tree dependency structures', () => {\n  it('allows binary tree (Aâ†’B,C; Bâ†’D,E; Câ†’F,G)', async () => {\n    expect(await module.get(A)).toBeDefined();\n  });\n  \n  it('allows unbalanced trees', async () => {\n    // Root with multiple children at different depths\n  });\n});\n```\n\n### 4. Mixed Valid Patterns (10 tests)\n- Multiple disconnected DAGs\n- DAGs with shared leaves\n- Large valid graphs (100+ providers)\n\n## Test File\n\n```\npackages/core/test/proxy-providers/circular-deps-valid-dags.spec.ts\n```\n\n## Success Criteria\n\n- âœ… 50 tests passing\n- âœ… **ZERO false positives** (all valid DAGs work correctly)\n- âœ… No performance degradation for large valid graphs\n- âœ… Resolution succeeds within expected timeframe\n- âœ… Coverage includes all DAG validation paths\n\n## Related\n\n- Part of ROADMAP.md Ronda 4 (Validation)\n- Relates to #4 (parent epic)\n- Depends on #17 (DependencyGraph integration) - âœ… Completed\n\n## Estimated Effort\n\n- Test implementation: 1.5-2 hours\n- Total: ~2 hours (ATOMIC)","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8NUw","name":"core","description":"Core package changes","color":"D73A4A"},{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":29,"reactionGroups":[],"state":"OPEN","title":"test(core): Valid DAGs - no false positives (50 tests)"},{"body":"**Milestone:** Architectural Refactor v7.0\n**Related:** Part 12/13 of architectural refactor (see ROADMAP.md)\n\n**Objective:** Validar todos os modos de propagaÃ§Ã£o com edge cases\n\n**Scope:**\n- Propagation.Required with nested awaited\n- Propagation.Required with nested NON-awaited\n- Propagation.RequiresNew with nested\n- Propagation.Nested with nested\n- Multiple nesting levels (3+)\n- Race conditions (parent complete, child active, new sibling starts)\n\n**Files:**\n- Update: `packages/transactional/test/edge-cases/nested-non-awaited-transaction.spec.ts`\n- Create: `packages/transactional/test/propagation/complex-nesting.spec.ts`\n- Create: `packages/transactional/test/propagation/race-conditions.spec.ts`\n\n**Acceptance Criteria:**\n- âœ… All 6 propagation modes tested with nested scenarios\n- âœ… Non-awaited transactions don't cause crashes\n- âœ… Coverage >90% in transaction-host.ts\n- âœ… Performance benchmarks don't degrade\n\n**Dependencies:** Previous transactional implementation","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"},{"id":"LA_kwDOQ93_Vc8AAAACVf8PSw","name":"transactional","description":"Transactional package changes","color":"FF8C00"},{"id":"LA_kwDOQ93_Vc8AAAACVnAEaQ","name":"epic","description":"Parent issue broken into multiple sub-issues","color":"0052CC"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":13,"reactionGroups":[],"state":"OPEN","title":"[Test] Comprehensive propagation mode test suite with nested non-awaited scenarios"},{"body":"**Milestone:** Architectural Refactor v7.0\n**Related:** Part 9/13 of architectural refactor (see ROADMAP.md)\n\n**Objective:** Validar que Symbol+WeakMap resolve falsos negativos\n\n**Scope:**\n- Context with Proxy wrapper\n- Context with Object.create() clone\n- Context with jest.mock() spy\n- Frozen context (Object.freeze())\n- Sealed context (Object.seal())\n- Multiple enhancers with request transformation\n\n**Files:**\n- `packages/core/test/edge-cases/proxy-context-tracking.spec.ts`\n- `packages/core/test/edge-cases/frozen-context-tracking.spec.ts`\n- `packages/core/test/edge-cases/mock-context-tracking.spec.ts`\n\n**Acceptance Criteria:**\n- âœ… 100% of documented edge cases pass\n- âœ… Coverage >95%\n- âœ… No race conditions introduced\n\n**Dependencies:** Previous core implementation","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8NUw","name":"core","description":"Core package changes","color":"D73A4A"},{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"},{"id":"LA_kwDOQ93_Vc8AAAACVnAEaQ","name":"epic","description":"Parent issue broken into multiple sub-issues","color":"0052CC"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":10,"reactionGroups":[],"state":"OPEN","title":"[Test] Edge case tests for context tracking with Proxy objects and mocks"},{"body":"**Milestone:** Architectural Refactor v7.0\n**Related:** Part 6/13 of architectural refactor (see ROADMAP.md)\n\n**Objective:** Validar compatibilidade multi-framework\n\n**Scope:**\n- Integration tests with Express 4 and 5\n- Integration tests with Fastify 4 and 5\n- Integration tests with Koa 2\n- Multiple enhancers scenario (ClsMiddleware + ClsGuard + ClsInterceptor)\n- Validate no context leak between requests\n\n**Files:**\n- `packages/core/test/integration/express-context-identity.spec.ts`\n- `packages/core/test/integration/fastify-context-identity.spec.ts`\n- `packages/core/test/integration/koa-context-identity.spec.ts`\n- `packages/core/test/integration/multi-enhancer.spec.ts`\n\n**Acceptance Criteria:**\n- âœ… 100 concurrent requests without context leak\n- âœ… Works with all supported framework versions\n- âœ… Coverage >90%\n\n**Dependencies:** Previous core implementation","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8NUw","name":"core","description":"Core package changes","color":"D73A4A"},{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"},{"id":"LA_kwDOQ93_Vc8AAAACVnAEaQ","name":"epic","description":"Parent issue broken into multiple sub-issues","color":"0052CC"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":7,"reactionGroups":[],"state":"OPEN","title":"[Test] Integration tests for request identity across Express/Fastify/Koa"},{"body":"**Milestone:** Architectural Refactor v7.0\n**Related:** Part 3/13 of architectural refactor (see ROADMAP.md)\n\n**Objective:** Garantir robustez com testes exaustivos\n\n**Scope:**\n- Ciclos simples (Aâ†’Bâ†’A)\n- Ciclos complexos (Aâ†’Bâ†’Câ†’Dâ†’B)\n- Ciclos auto-referenciados (Aâ†’A)\n- MÃºltiplos ciclos independentes\n- DAGs vÃ¡lidos (grafos acÃ­clicos)\n- 1000+ providers sem ciclos (teste de performance)\n\n**Files:**\n- `packages/core/test/proxy-providers/circular-dependencies.spec.ts` (new)\n- `packages/core/test/proxy-providers/performance-stress.spec.ts` (new)\n\n**Acceptance Criteria:**\n- âœ… Coverage >95% in proxy-provider-resolver.ts\n- âœ… Performance tests ensure O(V+E) complexity\n- âœ… Edge cases: 0 providers, 1 provider, providers without deps\n\n**Dependencies:** Previous core implementation","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVf8NUw","name":"core","description":"Core package changes","color":"D73A4A"},{"id":"LA_kwDOQ93_Vc8AAAACVf8OXg","name":"test","description":"Test implementation","color":"0E8A16"},{"id":"LA_kwDOQ93_Vc8AAAACVnAEaQ","name":"epic","description":"Parent issue broken into multiple sub-issues","color":"0052CC"}],"milestone":{"number":1,"title":"Architectural Refactor v7.0","description":"Complete architectural refactor replacing fragile workarounds with structural solutions for issues #169, #223, #129, #196","dueOn":"2026-03-10T00:00:00Z"},"number":4,"reactionGroups":[],"state":"OPEN","title":"[Test] Comprehensive circular dependency test suite for Proxy Providers"},{"body":"> **Note:** This issue is reproduced from the original repository: https://github.com/Papooch/nestjs-cls/issues/404\n\nI'm using a tenant-per-database setup and durable providers for TENANT_KYSELY_CONNECTION.\n\nAfter upgrading @nestjs-cls/transactional from 2.5.1 to 2.6.0, I noticed an issue:\nWhen making requests in the following sequence â€” Tenant A â†’ Tenant B â†’ Tenant A â€”\nthe second request for Tenant A incorrectly returns Tenant B's connection (and data) ðŸ˜…\n\nHere's the comparison between the versions:\nhttps://github.com/Papooch/nestjs-cls/compare/%40nestjs-cls/transactional%402.5.1...%40nestjs-cls/transactional%402.6.0\n\nI'll try to create a reproducible example soon, but I'm not doing anything unusual.\nDowngrading back to 2.5.1 resolves the issue.\n\n\nA sample outline of the module. Everything in the registry is correct, it just the front txHost connection a service that uses it.\n\n\\`\\`\\`ts\n@Global()\n@Module({\n  imports: [ClsModule],\n  providers: [TenantKyselyRegistry],\n  exports: [TenantKyselyRegistry],\n})\nexport class TenantKyselyModule {\n  public static register(): DynamicModule {\n    return {\n      module: TenantKyselyModule,\n      imports: [\n        RequestConnectionModule,\n        VaultModule,\n        ConfigModule,\n        ClsModule.forRoot({\n          plugins: [\n            new ClsPluginTransactional({\n              imports: [],\n              adapter: new TransactionalAdapterKysely({\n                kyselyInstanceToken: TENANT_KYSELY_CONNECTION,\n              }),\n            }),\n          ],\n        }),\n      ],\n      providers: [\n        {\n          provide: TENANT_KYSELY_CONNECTION,\n          scope: Scope.REQUEST,\n          durable: true,\n          inject: [\n            REQUEST,\n            TenantKyselyRegistry,\n            ConfigService,\n          ],\n          useFactory: (  request) => {\n              const tenantId = request.headers['tenant-id']\n               const { db } = registry.getOrCreate(tenantId, { database: tenantId , ....});\n               return db;\n           },\n        },\n      ],\n      exports: [TENANT_KYSELY_CONNECTION],\n    };\n  }\n}\n\n@Injectable()\nexport class TenantKyselyRegistry implements OnApplicationShutdown {\n  private readonly registry = new Map<string, PoolEntry>();\n  private readonly logger = new Logger('TenantKyselyRegistry');\n\n  getOrCreate(tenantId: string, poolConfig: PoolConfig): PoolEntry {\n    const key = \\`\\${tenantId}\\`;\n    const existing = this.registry.get(key);\n    if (existing) return existing;\n\n    const pool = new Pool(poolConfig);\n    const db = new Kysely<unknown>({\n      dialect: new PostgresDialect({ pool }),\n    });\n    const entry = { pool, db } as const;\n    this.registry.set(key, entry);\n    return entry;\n  }\n\n  async onApplicationShutdown() {\n    const entries = Array.from(this.registry.values());\n    await Promise.allSettled(entries.map((e) => e.pool.end()));\n    this.registry.clear();\n  }\n}\n\n\n\\`\\`\\`","labels":[{"id":"LA_kwDOQ93_Vc8AAAACVfu0KA","name":"investigation","description":"Why is this happening?","color":"2EE366"},{"id":"LA_kwDOQ93_Vc8AAAACVfu0xw","name":"solved","description":"The question was answered or the problem was solved","color":"2EE91C"}],"milestone":null,"number":1,"reactionGroups":[],"state":"OPEN","title":"Regression: Tenant connection mix-up after upgrading from 2.5.1 to 2.6.0"}]
